<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Uniswap V3 Dashboard</title>
<style>
  :root {
    --primary: #ff007a;
    --bg-dark: #0e0f11;
    --bg-card: #1b1e22;
    --text: #e6e6e6;
    --accent: #00f0ff;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(to bottom, #0e0f11, #121417);
    color: var(--text);
    padding: 40px 20px;
    max-width: 1200px;
    margin: auto;
  }

  h1, h2 {
    color: var(--primary);
    font-weight: 600;
    margin-bottom: 20px;
  }

  .header-row {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 40px;
  }

  @media (min-width: 768px) {
    .header-row {
      flex-direction: row;
      align-items: center;
    }
  }

  .quote-box {
    background: var(--bg-card);
    border: 1px solid #292c31;
    border-radius: 16px;
    padding: 16px 20px;
    box-shadow: 0 0 8px rgba(0, 240, 255, 0.1);
    min-width: 260px;
  }

  input, button {
    padding: 10px 12px;
    font-size: 1rem;
    border-radius: 8px;
    border: none;
    margin-top: 10px;
    margin-right: 8px;
  }

  input {
    width: 140px;
    background: #111;
    color: var(--text);
    border: 1px solid #333;
  }

  button {
    background-color: var(--primary);
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  button:hover {
    background-color: #e60070;
  }

  #quoteResult {
    margin-top: 15px;
    font-size: 1rem;
    font-weight: 500;
    color: var(--accent);
  }

  .chart-grid {
    display: flex;
    flex-direction: column;
    gap: 30px;
    margin-bottom: 40px;
  }

  .chart-card {
    background: var(--bg-card);
    padding: 20px;
    border-radius: 16px;
    border: 1px solid #292c31;
    box-shadow: 0 0 8px rgba(0, 240, 255, 0.08);
  }

@media (min-width: 768px) {
  .chart-grid {
    flex-direction: row;
    justify-content: space-between; /* spread out */
    align-items: stretch;
  }

  .chart-card {
    flex: 1 1 0%;
    max-width: 48%; /* prevent too wide on large screens */
  }
}
.chart-card canvas {
  width: 100% !important;
}




  .card {
    background: var(--bg-card);
    border: 1px solid #292c31;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 0 8px rgba(255, 0, 122, 0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .card:hover {
    transform: scale(1.015);
    box-shadow: 0 0 14px rgba(255, 0, 122, 0.2);
  }

  .token-pair {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--accent);
  }

  .metric {
    margin-bottom: 6px;
    font-size: 0.95rem;
  }
</style>

</head>
<body>
  <div class="header-row">
  <h1>Uniswap V3 Dashboard</h1>
  <div class="quote-box">
    <label for="ethInput">Live ETH ‚Üí USDC</label><br />
    <input id="ethInput" type="number" step="0.01" placeholder="Enter ETH" />
    <button onclick="getQuote()">Get Quote</button>
    <p id="quoteResult"></p>
  </div>
</div>


<div class="chart-grid">
  <div class="chart-card">
    <h2>üìä Historical TVL / Volume (7 Days)</h2>
    <canvas id="lineChart" width="600" height="300"></canvas>
  </div>
  <div class="chart-card">
    <h2>üìä Top Pool TVL Comparison</h2>
    <canvas id="barChart" width="600" height="300"></canvas>
  </div>
</div>


<h1>Top 5 Pools by Volume</h1>


  {% for pool in pools %}
    <div class="card">
  <div class="token-pair">{{ pool.token0.symbol }}/{{ pool.token1.symbol }}</div>
  <div class="metric">üîÑ Volume (USD): ${{ "%.2f"|format(pool.volumeUSD|float) }}</div>
  <div class="metric">üîí TVL (USD): ${{ "%.2f"|format(pool.totalValueLockedUSD|float) }}</div>
  <div class="metric">üí∏ Fee Tier: 
    <span title="This is the swap fee collected per trade">
      {{ "%.2f"|format(pool.feeTier|float / 10000 * 100) }}%
    </span>
  </div>
  <div class="metric">üìä Raw Liquidity Units: {{ "{:,}".format(pool.liquidity|int) }}</div>
  <div class="metric">
    üß© Token0: <a href="https://etherscan.io/address/{{ pool.token0.id }}" target="_blank">{{ pool.token0.symbol }}</a>
  </div>
  <div class="metric">
    üß© Token1: <a href="https://etherscan.io/address/{{ pool.token1.id }}" target="_blank">{{ pool.token1.symbol }}</a>
  </div>
  <div class="metric">üîó Pool: 
    <a href="https://etherscan.io/address/{{ pool.id }}" target="_blank">
      {{ pool.id[:6] }}...{{ pool.id[-4:] }}
    </a>
  </div>
</div>


  {% else %}
    <div class="card">No pool data available.</div>
  {% endfor %}


<script>
  async function getQuote() {
    const amount = document.getElementById("ethInput")?.value;
    const resultBox = document.getElementById("quoteResult");

    if (!amount || isNaN(amount) || Number(amount) <= 0) {
      resultBox.innerText = "‚ö†Ô∏è Please enter a valid ETH amount.";
      return;
    }

    try {
      const response = await fetch(`/api/subgraph-quote`);
      const data = await response.json();

      if (data.ethPriceUSD && data.ethPriceUSD > 0) {
        const price = parseFloat(data.ethPriceUSD);
        const usdc = (Number(amount) * price).toFixed(2);
        resultBox.innerText = `${amount} ETH ‚âà $${usdc} USDC`;
      } else {
        resultBox.innerText = "‚ö†Ô∏è Couldn't get price from subgraph.";
      }
    } catch (error) {
      console.error("Error fetching quote:", error);
      resultBox.innerText = "‚ùå Failed to fetch quote.";
    }
  }

  async function renderChart() {
    const canvas = document.getElementById("lineChart");
    if (!canvas) {
      console.warn("‚õî lineChart canvas not found.");
      return;
    }

    try {
      const res = await fetch("/api/pool-history");
      const data = await res.json();
      console.log("üìà Line chart data:", data);

      const ctx = canvas.getContext("2d");

      new Chart(ctx, {
        type: "line",
        data: {
          labels: data.labels.map(ts => {
            const d = new Date(ts * 1000);
            return `${d.getMonth() + 1}/${d.getDate()}`;
          }),
          datasets: [
            {
              label: "TVL (USD)",
              data: data.tvl,
              borderWidth: 2,
              borderColor: "#00f0ff",
              backgroundColor: "transparent",
              tension: 0.3
            },
            {
              label: "Volume (USD)",
              data: data.volume,
              borderWidth: 2,
              borderColor: "#ff007a",
              backgroundColor: "transparent",
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: value => `$${Number(value).toLocaleString()}`
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: "#e6e6e6"
              }
            }
          }
        }
      });
    } catch (err) {
      console.error("‚ùå Failed to load line chart:", err);
    }
  }

  async function renderBarChart() {
    const canvas = document.getElementById("barChart");
    if (!canvas) {
      console.warn("‚õî barChart canvas not found.");
      return;
    }

    try {
      const res = await fetch("/api/top-pools-tvl");
      const data = await res.json();
      console.log("üìä Bar chart data:", data);

      const ctx = canvas.getContext("2d");

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.labels,
          datasets: [{
            label: "TVL (USD)",
            data: data.tvls,
            backgroundColor: "#00f0ff",
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: value => `$${Number(value).toLocaleString()}`
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: "#e6e6e6"
              }
            }
          }
        }
      });
    } catch (err) {
      console.error("‚ùå Failed to load bar chart:", err);
    }
  }

  // Run charts on page load
  renderChart();
  renderBarChart();
</script>

</body>
</html>
